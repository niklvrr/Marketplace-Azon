# Маркетплейс Azon

**Azon** — это бэкенд-сервис для торговой площадки, реализованный на Go. 
Проект представляет собой REST API, которое позволяет пользователям регистрироваться, 
продавать и покупать товары. Архитектура выполнена в виде монолита с четким разделением на слои, 
что упрощает поддержку и дальнейшее развитие.

---

## Ключевые функции

* **Аутентификация и авторизация:** Безопасная система на основе JWT-токенов.
* **Безопасный выход:** Реализация черного списка JWT-токенов в Redis при выходе из системы.
* **Управление товарами:** Функционал создания, редактирования, поиска и получения товаров.
* **Корзина и Заказы:** CRUD функционал добавления товаров в корзину и оформления заказов.
* **Кэширование:** Использование Redis для кэширования часто запрашиваемых данных и ускорения ответов.
* **Админ-панель:** Набор эндпоинтов для администрирования пользователей и модерации товаров.

---

## Технологический стек

-   **Язык:** Go 1.25.0
-   **Веб-фреймворк:** Gin
-   **База данных:** PostgreSQL
-   **Кэш:** Redis
-   **Контейнеризация:** Docker, Docker Compose
-   **Миграции:** golang-migrate

---

## Требования

Для запуска и работы с проектом вам понадобятся:
* Docker и Docker Compose
* Go 1.25.0 (для запуска тестов и локальной разработки)

---

## Установка и запуск

1.  **Клонируйте репозиторий:**
    ```sh
    git clone https://github.com/niklvrr/Marketplace-Azon.git
    ```

2.  **Настройте переменные окружения:**
    Создайте файл `.env` в корне проекта, скопировав содержимое из `configs/config.yaml` и заменив значения на свои. Обязательные переменные:
    ```env
    DB_URL=postgres://user:password@postgres-db:5432/dbname?sslmode=disable
    DB_NAME=db_name
    DB_PASSWORD=db_password
    DB_USER=user_name
    JWT_SECRET=jwt_secret
    REDIS_ADDR=redis-cache:6379
    ```

3.  **Примените миграции базы данных:**
    Убедитесь, что `golang-migrate` установлен. Выполните команду:
    ```sh
    migrate -path ./migrations -database "${DB_URL}" up
    ```
    *(Замените `${DB_URL}` на ваше значение из `.env`)*

4.  **Запустите проект с помощью Docker Compose:**
    ```sh
    docker-compose up --build
    ```
    Сервис будет доступен по адресу `http://localhost:8080`.

## Тестирование

Проект покрыт unit- и интеграционными тестами (~70%). Для запуска всех тестов выполните команду:
```sh
go test ./...
```

## Примеры использования API

**Регистрация нового пользователя:**

```sh
curl -X POST http://localhost:8080/api/v1/users/signup \
-H "Content-Type: application/json" \
-d '{
    "name": "John Doe",
    "email": "john.doe@example.com",
    "password": "securepassword123"
}'
```

# Документация по проекту "Маркетплейс Azon"

## 1. Архитектура

Проект реализован в виде **монолитного приложения** с четкой **слоистой архитектурой (Layered Architecture)**. Такое разделение позволяет изолировать бизнес-логику от деталей реализации (например, от базы данных или веб-фреймворка) и упрощает тестирование и поддержку.

**Жизненный цикл запроса:**
1.  Запрос поступает в **`Router`** (`internal/api/router`), который определяет, какой обработчик должен его выполнить.
2.  При необходимости запрос проходит через **`Middleware`** (`internal/api/middleware`) для проверки JWT-токена.
3.  **`Handler`** (`internal/handler`) принимает запрос, валидирует его и вызывает соответствующий метод сервиса. Этот слой отвечает за работу с HTTP.
4.  **`Service`** (`internal/service`) содержит основную бизнес-логику, свободную от деталей HTTP. Он координирует работу с репозиториями.
5.  **`Repository`** (`internal/repository`) отвечает за взаимодействие с базами данных (PostgreSQL, Redis). Он скрывает детали выполнения SQL-запросов или команд Redis.
6.  **`Model`** (`internal/model`) определяет структуры данных, используемые во всем приложении.

## 2. Описание пакетов и слоёв

* `cmd/main.go`: Точка входа в приложение. 
* `internal/api`: Пакет, отвечающий за все, что связано с API.
    * `middleware`: Промежуточное ПО (например, для проверки JWT).
    * `router`: Определение и группировка всех HTTP-маршрутов.
* `internal/app`: Содержит логику инициализации конфигурации, зависимостей и запуск сервера.
* `internal/config`: Логика загрузки конфигурации из `.yaml` и переменных окружения.
* `internal/db`, `internal/rdb`: Пакеты для установки соединения с PostgreSQL и Redis соответственно.
* `internal/handler`: Слой обработки HTTP-запросов. Преобразует HTTP-запросы в вызовы методов сервиса.
* `internal/service`: Слой бизнес-логики.
* `internal/repository`: Слой доступа к базе данных.
* `internal/model`: Структуры данных (запросы, ответы, модели БД).
* `migrations`: SQL-файлы для миграций базы данных (`golang-migrate`).
* `pkg`: Вспомогательные пакеты, которые могут быть переиспользованы (JWT, логгер, утилиты).

## 3. Работа с конфигурацией

Конфигурация проекта гибридная:
* **`configs/config.yaml`**: хранит значения по умолчанию, которые не являются секретными.
* **`.env`**: используется для переопределения значений из `yaml` и для хранения секретов (ключ JWT, URL базы данных). Переменные из этого файла имеют приоритет.

Для запуска приложения необходимо определить следующие переменные окружения в файле `.env`:

| Переменная    | Описание                               | Пример                                                         |
|---------------|----------------------------------------|----------------------------------------------------------------|
| `DB_URL`      | Строка подключения к PostgreSQL        | `postgres://user:pass@postgres-db:5432/dbname?sslmode=disable` |
| `DB_NAME`     | Название базы данных                   | `db_name`                                                      |
| `DB_PASSWORD` | Пароль базы данных                     | `db_password`                                                  |
| `DB_USER`     | Пользователь базы данных               | `user_name`                                                    |
| `JWT_SECRET`  | Секретный ключ для подписи JWT-токенов | `jwt_secret`                                                   |
| `REDIS_ADDR`  | Адрес сервера Redis                    | `redis-cache:6379`                                             |

### Описание API

Ниже представлен список всех доступных эндпоинтов API, сгруппированных по ресурсам.

#### Пользователи (`/api/v1/user`)
| Метод | Путь | Описание |
| :--- | :--- | :--- |
| `POST` | `/signup` | Регистрация нового пользователя. |
| `POST` | `/login` | Вход в систему и получение JWT-токена. |
| `GET` | `/` | Получение информации о текущем пользователе по токену. |
| `PUT` | `/` | Обновление информации текущего пользователя. |
| `POST` | `/` | Получение информации о пользователе по email. |
| `PUT` | `/role` | Обновление роли пользователя (только для администраторов). |
| `POST` | `/logout` | Выход из системы (добавление токена в черный список). |
| `PUT` | `/admin/block` | Блокировка пользователя по ID (только для администраторов). |
| `PUT` | `/admin/unblock` | Разблокировка пользователя по ID (только для администраторов). |
| `GET` | `/admin` | Получение списка всех пользователей (только для администраторов). |
| `PUT` | `/admin/approve`| Одобрение товара (только для администраторов). |

#### Товары (`/api/v1/products`)
| Метод | Путь | Описание |
| :--- | :--- | :--- |
| `GET` | `/:id` | Получение товара по ID. |
| `GET` | `/` | Получение списка всех товаров с пагинацией. |
| `GET` | `/search` | Поиск товаров по параметрам. |
| `POST` | `/` | Создание нового товара (только для продавцов и администраторов). |
| `PUT` | `/:id` | Обновление товара по ID (только для продавцов и администраторов). |
| `DELETE`| `/:id` | Удаление товара по ID (только для продавцов и администраторов). |

#### Заказы (`/api/v1/order`)
| Метод | Путь | Описание |
| :--- | :--- | :--- |
| `POST` | `/` | Создание нового заказа из корзины. |
| `GET` | `/history` | Получение истории заказов текущего пользователя. |
| `GET` | `/items/:id` | Получение товарных позиций конкретного заказа. |
| `GET` | `/:id` | Получение заказа по ID. |
| `DELETE`| `/:id` | Удаление заказа по ID. |

#### Категории (`/api/v1/categories`)
| Метод | Путь | Описание |
| :--- | :--- | :--- |
| `GET` | `/` | Получение списка всех категорий. |
| `POST` | `/` | Создание новой категории (только для администраторов). |
| `GET` | `/:id` | Получение категории по ID (только для администраторов). |
| `PUT` | `/:id` | Обновление категории по ID (только для администраторов). |
| `DELETE`| `/:id` | Удаление категории по ID (только для администраторов). |

#### Корзина (`/api/v1/cart`)
| Метод | Путь | Описание |
| :--- | :--- | :--- |
| `GET` | `/` | Получение корзины текущего пользователя. |
| `GET` | `/:id` | Получение товарных позиций из корзины. |
| `POST` | `/` | Добавление товара в корзину. |
| `DELETE`| `/` | Удаление товара из корзины. |
| `DELETE`| `/clear` | Полная очистка корзины. |

## 5. Тестирование

Проект содержит unit- и интеграционные тесты. Unit-тесты изолируют логику с помощью моков (библиотека `testify/mock`). Интеграционные тесты проверяют взаимодействие с реальной (тестовой) базой данных.

**Запуск всех тестов:**
```sh
go test ./...
````

**Запуск тестов с отображением покрытия:**

```sh
go test ./... -cover
```